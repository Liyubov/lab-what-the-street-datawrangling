<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Coiling Example</title>
    <style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Helvetica Neue', sans-serif;
    }
    
    h1 {
        padding-top: 15px;
    }
    
    h2 {
        font-weight: normal;
        padding-bottom: 15px;
    }
    
    h1,
    h2 {
        font-size: 18px;
        width: 800px;
        margin: auto;
    }
    
    svg {
        margin: auto;
        display: block;
    }
    
    #svg {
        position: absolute;
        text-align: center;
        color: #ababab;
        transition: 0.3s;
    }
    
    #bottom {
        position: fixed;
        bottom: 30px;
        left: 130px;
        text-align: right;
        font-size: 1.5rem;
    }
    
    #canvas {
        /*background: rgba(0,0,0,0.1);*/
        position: absolute;
        top: 0;
        left: 0;
    }
    
    #bottom:hover {
        cursor: pointer;
    }
    
    #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        transition: opacity 0.3s;
    }
    
    #mapWrapper {
        position: relative;
    }
    
    .invisible {
        opacity: 0.00001;
    }
    </style>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.28.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.28.0/mapbox-gl.css' rel='stylesheet' />
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/3.0.14/turf.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>
    <script type="text/javascript" src="../../../scripts/helpers.js"></script>
    <script type="text/javascript" src="../../../scripts/unfold.js"></script>
    <script type="text/javascript" src="../../../scripts/coil.js"></script>
    <script type="text/javascript">
    var map;

    $.easing.easeOutBounce = function(x, t, b, c, d) {
        if ((t /= d) < (1 / 2.75)) {
            return c * (7.5625 * t * t) + b;
        } else if (t < (2 / 2.75)) {
            return c * (7.5625 * (t -= (1.5 / 2.75)) * t + .75) + b;
        } else if (t < (2.5 / 2.75)) {
            return c * (7.5625 * (t -= (2.25 / 2.75)) * t + .9375) + b;
        } else {
            return c * (7.5625 * (t -= (2.625 / 2.75)) * t + .984375) + b;
        }
    };

    $(document).ready(function() {
        mapboxgl.accessToken = 'pk.eyJ1IjoiYm9nbmVyc3RlcGhhbiIsImEiOiJBMnlqbnZrIn0.YwiGRgpheNMPujZn-JBh6Q';
        map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
            center: [-74.50, 40], // starting position
            zoom: 9 // starting zoom
        });

        map.on('load', function() {
            addSource('street');
        });

        $('#bottom').on('click', function() {
            $('html, body').animate({
                scrollTop: $("#conclusion").offset().top
            }, 30000);
        })
        processFile("../data/170213_berlin_streets.json");
    });

    function processFile(url) {
        $.getJSON(url, function(streets) {

            var parkingSvgHeight = 20584;
            var parkingArea = 8156098.06;


            var widthCounter = 0;
            var gapBetweeStreets = 0.002; //in km


            var widthInPixels = 592;
            var widthInMeter = widthInPixels * 1.2672955975; //value was measured;

            meterPerPixel = widthInMeter / widthInPixels;
            pixelPerMeter = widthInPixels / widthInMeter;
            console.log(pixelPerMeter);

            var coiledStreets = [];
            var vectorStreets = [];

            var debugLimitStreets = 40;

            var lengthInM = 0;
            var entireArea = 0;
            for (var i = 0; i < streets.length; i++) {
                var street = streets[i];
                //console.log(street);
                lengthInM += street.tags.length;
                lengthInM += gapBetweeStreets * 1000;
                entireArea += street.tags.area;
                if (i > debugLimitStreets) {
                    break;
                }
            }

            var desiredHeight = entireArea / parkingArea * parkingSvgHeight;
            console.log(lengthInM + 'm', entireArea + 'm2');

            var positionOnCoilCounter = 0;
            coil.setProperties(widthInMeter, 5);

            var coilHeightInPixels = desiredHeight;
            var properties = coil.setHeight(coilHeightInPixels, lengthInM, pixelPerMeter);
            for (var i = 0; i < streets.length; i++) {
                var street = streets[i];
                var vectorStreet = unfold.getStreetWithVectors(street);
                var vectorStreetDivided = unfold.subdivideVectorStreet(vectorStreet, 3);

                var coiledStreet = coil.getCoiledStreet(vectorStreetDivided, positionOnCoilCounter, 150, 5);
                positionOnCoilCounter += (coiledStreet.coilEnd - coiledStreet.coilStart)
                positionOnCoilCounter += gapBetweeStreets;

                console.log(coiledStreet);
                console.log(vectorStreetDivided);

                coiledStreets.push(coiledStreet);
                vectorStreets.push(vectorStreetDivided);

                if (i > debugLimitStreets) {
                    break;
                }
            };

            var svgCode = coil.generateSvg(coiledStreets, meterPerPixel, coilHeightInPixels);
            $('#svg').html(svgCode);

            var streets = {};
            for (var i = 0; i < coiledStreets.length; i++) {
                var coiledStreet = coiledStreets[i];
                var vectorStreet = vectorStreets[i];
                streets[coiledStreet['_id']] = {};
                streets[coiledStreet['_id']].from = vectorStreet;
                streets[coiledStreet['_id']].to = coiledStreet;
            };

            $('path').click(function() {
                $('#map').css('top', ($(document).scrollTop() - $('#mapWrapper').offset().top) + 'px')

                var offset = $('#mapWrapper').offset().top - $('#map').offset().top;
                console.log(offset);

                console.log(this.id);
                var street = streets[this.id]
                var coiledStreetToUncoil = street.to;
                var vectorStreetToUncoil = street.from;


                delete coiledStreetToUncoil.subVectors;
                delete coiledStreetToUncoil.originalLengths;
                delete coiledStreetToUncoil.length;

                delete vectorStreetToUncoil.coilEnd;
                delete vectorStreetToUncoil.length;
                delete vectorStreetToUncoil.coilStart;
                delete vectorStreetToUncoil.subVectors;
                delete vectorStreetToUncoil.originalLengths;
                delete vectorStreetToUncoil.totalVariation;

                console.log('street', street);
                console.log('coiledStreetToUncoil', coiledStreetToUncoil);
                console.log('vectorStreetToUncoil', vectorStreetToUncoil);
                


                $(this).hide();
                $('#svg').addClass('invisible');
                $('#map').removeClass('invisible');
                console.log('clicked');
                

                var zoomLevel = getZoomLevel(coiledStreetToUncoil.origin.lat, meterPerPixel)
                map.setZoom(zoomLevel);

                var x = coil.getPadding()[1] / 2 + coiledStreetToUncoil.coilOrigin.x / (meterPerPixel / 1000);
                var y = coil.getPadding()[0] / 2 + offset + coiledStreetToUncoil.coilOrigin.y / (meterPerPixel / 1000);

                var percentagePixelHor = (x / $('#map').width());
                var percentagePixelVer = (y / $('#map').height());

                var newCenter = [coiledStreetToUncoil.origin.lon, coiledStreetToUncoil.origin.lat];

                centerAt(map, newCenter, percentagePixelHor, percentagePixelVer);

                var bounds = [vectorStreetToUncoil.bounds.ne, vectorStreetToUncoil.bounds.sw];

                var geoJson = unfold.geoJsonStreetAnimation(vectorStreetToUncoil, coiledStreetToUncoil, 0, 0);
                map.getSource('street').setData(geoJson);

                window.setTimeout(function() {
                    window.setTimeout(function() {
                        map.fitBounds(bounds, {
                            maxZoom: zoomLevel,
                            padding: 30,
                            speed: 0.3
                        });
                    }, 500);


                    map.on('moveend', function() {
                        animate(vectorStreetToUncoil, coiledStreetToUncoil);
                    })
                }, 700);
            });
        });
    }

    function animate(vectorStreet, coiledStreet) {
        var timingFactor = Math.max(coiledStreet.length * 150, 1000);

        var geoJson = unfold.geoJsonStreetAnimation(vectorStreet, coiledStreet, 0, 0);
        map.getSource('street').setData(geoJson);

        $({
            progressUnfold: 0
        }).delay(200).animate({
            progressUnfold: 1
        }, {
            duration: timingFactor * 2,
            easing: "easeOutBounce",
            progress: function(animation, progress) {
                var geoJson = unfold.geoJsonStreetAnimation(vectorStreet, coiledStreet, this.progressUnfold, 0);
                map.getSource('street').setData(geoJson);
            },
            complete: function(argument) {
                $({
                    progressStitch: 0
                }).delay(300).animate({
                    progressStitch: 1
                }, {
                    duration: timingFactor * 1.2,
                    easing: "easeInOutBack",
                    progress: function(animation, progress) {
                        var geoJson = unfold.geoJsonStreetAnimation(vectorStreet, coiledStreet, 1, this.progressStitch);
                        map.getSource('street').setData(geoJson);
                    },
                    complete: function() {
                        // $({progressUnfold: 1, progressStitch: 1}).delay(800).animate(
                        //     {progressUnfold: 0, progressStitch: 0}, 
                        //     {duration: timingFactor*2, 
                        //      easing: "easeInOutCubic",
                        //      progress: function(animation, progress) {
                        //         clearCanvas();
                        //         var geoJson = unfold.geoJsonStreetAnimation(vectorStreet, coiledStreet, this.progressUnfold, this.progressStitch);}
                        //          map.getSource('street').setData(geoJson);
                        //         , complete: function(){
                        //             //animate(vectorStreet, coiledStreet)
                        //         }
                        //     })
                    }
                });
            }
        });
    }


    function addSource(name) {
        map.addSource(name, {
            "type": "geojson",
            "data": {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141]
                    ]
                }
            }
        });
        map.addLayer({
            "id": name,
            "type": "line",
            "source": name,
            "layout": {
                "line-join": "round",
                "line-cap": "round"
            },
            "paint": {
                "line-color": "#000",
                "line-width": 5
            }
        });
    }
    </script>
</head>

<body>
    <h1>Coiling Example</h1>
    <h2>How Coiling Streets Could Work</h2>
    <!-- <canvas id='canvas'></canvas>  -->
    <div id="mapWrapper">
        <div id="map" class="invisible"></div>
        <div id="svg">Calculating ... </br>(this will take a while)</div>
    </div>
    <div id="conclusion"></div>
    <!-- <div id="bottom">↓</div> -->
</body>

</html>