<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Unravel</title>
  </head>
  <body>
    <canvas id="myCanvas" width="4000" height="4000"></canvas>
    <style type="text/css">
    body{
      background: #eceaea;
    }
    canvas{
      background: white;
      margin: 30px;
    }
    </style>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/3.0.14/turf.js"></script>
        <script type="text/javascript" src="./js/async.min.js"></script>
        <script>
            var globalVectors = [];
            init();

            function init(){
              var urlToJson = "./data/Achillesstraße.json"
              var canvas = document.getElementById("myCanvas"); //reference canvas
              var canvasContext = canvas.getContext("2d"); //set context

              var pathToData = "./data/";
              //var filesToLoad = ['Achillesstraße.json', 'Columbiadamm.json', 'FrankfurterAllee.json', 'französischeStraße.json', 'Bäckerstraße.json', 'Wartburgstraße.json', 'Hohenstaufenstraße.json', 'Adlergestell.json'];
              var filesToLoad = ['Achillesstraße.json'];
              workFiles(pathToData, filesToLoad);
            }
            

            function workFiles(pathToData, filesToLoad){
              console.log('');
              console.log('---------------------------');
              console.log('# Start loading files');
              async.map(filesToLoad, function(fileName, callback){
                var urlToJson = pathToData + fileName;
                console.log('Loading '+ urlToJson);
                $.getJSON( urlToJson, function(street) {
                  console.log('Successfully loaded ' + urlToJson);
                  callback(null, street);
                });
              },function(err, streets){
                console.log('# All files loaded');
                console.log('---------------------------');
                console.log('streets', streets);
                iterateOverStreets(streets);
              });
            }

            function iterateOverStreets(streets){
              for (var i = 0; i < streets.length; i++) {
                var street = streets[i];
                var streetWithCoordinates = convertStreetToCoordinates( street );
                var streetWithVectors = convertToVectors( streetWithCoordinates );
                var onlyVectors = getOnlyVectorsFromStreets( streetWithVectors );
                console.log(i, streetWithCoordinates);
                console.log(i, streetWithVectors);
                console.log('---------------------------');
              }
              console.log(globalVectors);
              // var arrayToTest = [];
              // for (var i = 0; i < globalVectors.length; i++) {
              //   //console.log(globalVectors[i].street);
              //   if (globalVectors[i].type == 'street') {
              //     console.log('draw from ' + globalVectors[i].origin.lat + ', ' + globalVectors[i].origin.lon + ' to '  + globalVectors[i].destination.lat + ', ' + globalVectors[i].destination.lon);  
              //   }else{
              //     console.log('translate from ' + globalVectors[i].origin.lat + ', ' + globalVectors[i].origin.lon + ' to '  + globalVectors[i].destination.lat + ', ' + globalVectors[i].destination.lon); 
              //   }

              //   var loc = [globalVectors[i].destination.lon, globalVectors[i].destination.lat]
              //   arrayToTest.push(loc);
                
              //   //console.log('   c-' + globalVectors[i].componentIndex);
              //   //console.log('      p-' + globalVectors[i].pathIndex);
              //   //console.log('         v-' + globalVectors[i].vectorIndex + ' - ' + globalVectors[i].type);
              // };
              // console.log(JSON.stringify(arrayToTest));

              for (var i = 0; i < globalVectors.length; i++) {
                canvasContext.beginPath();
                canvasContext.lineWidth = 4;
                canvasContext.lineJoin = 'round';
                canvasContext.lineCap = 'round';
                if (i==0) {
                  canvasContext
                };
                globalVectors[i]
              };
            }

            function getOnlyVectorsFromStreets(street){
              var previouslyLastVector;
              var components = street.components;
              for (var k = 0; k < components.length; k++) {
                var component = components[k];
                console.log('component' + k);
                for (var i = 0; i < component.length; i++) {
                  var path = component[i];
                  //console.log('   path' + i);

                  for (var j = 0; j < path.length; j++) {
                    var vector = path[j];

                    if (j == 0 && k != 0) {
                      var from = turf.point([previouslyLastVector.destination.lon, previouslyLastVector.destination.lat]);
                      var to = turf.point([vector.origin.lon, vector.origin.lat]);
                      var distance = turf.distance(from, to);
                      var bearing = turf.bearing(from, to);

                      var translationVector = {};
                      translationVector.componentIndex = k-1;
                      translationVector.street = street.tags.name;
                      translationVector.bearing = bearing;
                      translationVector.distance = distance;
                      translationVector.origin = previouslyLastVector.destination;
                      translationVector.destination = vector.origin;
                      translationVector.type = "translate";
                      
                      globalVectors.push(translationVector)
                    };
                    
                    //console.log('      v' + j);

                    vector.componentIndex = k;
                    vector.pathIndex = i;
                    vector.vectorIndex = j;
                    vector.street = street.tags.name;
                    vector.type = "street";

                    globalVectors.push( vector );
                    if (j == path.length - 1) {
                      previouslyLastVector = vector;
                      //console.log('      last bit');
                    };
                  };
                };
              };
            }

            function convertToVectors(streetWithCoordinates){
              //One street = multiple graphs, if split by gap
              var components = streetWithCoordinates.components;
              var vectorComponents = [];
              for (var i = 0; i < components.length; i++) {
                //one component = one graph
                var component = components[i];
                vectorComponents[i] = [];
                var vectorComponent = vectorComponents[i];

                for (var j = 0; j < component.length; j++) {
                  //one path = one line (array of coordinates)
                  var path = component[j]; //= line
                  vectorComponent[j] = [];
                  var vectorPath = vectorComponent[j]

                  for (var k = 1; k < path.length; k++) {
                    //one coordinate = one point
                    var coordinate = path[k];
                    var previousCoordinate = path[k - 1];
                    var from = turf.point([previousCoordinate.lon, previousCoordinate.lat]);
                    var to = turf.point([coordinate.lon, coordinate.lat]);
                    var distance = turf.distance(from, to);
                    var bearing = turf.bearing(from, to);

                    var currentVector = {};
                        currentVector.origin = previousCoordinate;
                        currentVector.destination = coordinate;
                        currentVector.distance = distance;
                        currentVector.bearing = bearing;

                    vectorPath.push( currentVector );
                  };
                };
              };
              var output = {
                tags: streetWithCoordinates.tags,
                components: vectorComponents
              };
              return output
            }

            // function iterateOverStreets(streets){
            //   console.log('');
            //   console.log('---------------------------');
            //   console.log('# Start converting streets');
            //   for (var i = 0; i < streets.length; i++) {
            //     var street = streets[i];
            //     console.log('');
            //     console.log('Street' + i, street);
            //     iterateOverStreet(street);
            //   };
            //   console.log('# Converted all streets');
            //   console.log('---------------------------');
            // }

            // function iterateOverStreet(street){
            //   var components = street.components;
            //   for (var j = 0; j < components.length; j++) {
            //     var component = components[j];
            //     var paths = component;
            //     var nodes = street.nodes;
            //     if (j == 0) {
            //       console.log('move to');
            //     }else{
            //       console.log('translate to');
            //     }
                
            //     console.log('   Component ' + j);
            //     iterateOverPaths(paths, nodes);
            //     // if (j != components.length-1) {
            //     //   console.log('   Translation between components ' + j);  
            //     // };
            //   };
            // };

            // function iterateOverPaths(paths, nodes){
            //   for (var i = 0; i < paths.length; i++) {
            //     var path = paths[i];
            //     var coordinates = getCoordinatesFromNodes(path, nodes);
            //     console.log('      Path ' + i);
            //     // if (i != paths.length - 1) {
            //     //   console.log('      Translation between paths ' + i)
            //     // };
            //   };
            // }

            // function getCoordinatesFromNodes(path, nodes){
            //   var coordinates = [];
            //   for (var i = 0; i < path.length; i++) {
            //     var node = path[i];
            //     var coordinate = nodes[node];
            //     coordinates.push(coordinate);
            //   };
            //   return coordinates;
            // }

            function getAngleDifference(angle1, angle2){
              var d = angle1 - angle2
               while (d < -180) {
                  d += 360;
                };
                while (d > 180) {
                  d -= 360;
                };
              return d;
            }

            function toRadians(degrees) {
              return degrees * Math.PI / 180;
            };
             
            function toDegrees(radians) {
              return radians * 180 / Math.PI;
            };

            function map_range(value, low1, high1, low2, high2) {
                  return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
            }

            // function convertStreetFromCoordinatesToVectors(json){
            //   //One street = multiple graphs, if split by gap
            //   var components = json.components;
            //   var vectorComponents = [];
            //   for (var i = 0; i < components.length; i++) {
            //     //one component = one graph
            //     var component = components[i];
            //     vectorComponents[i] = [];
            //     var vectorComponent = vectorComponents[i];

            //     for (var j = 0; j < component.length; j++) {
            //       //one path = one line (array of coordinates)
            //       var path = component[j]; //= line
            //       var attributes = {};
            //       attributes.from = path[0];
            //       attributes.to = path[ path.length - 1 ];
            //       attributes.coordinates = path;
            //       attributes.bearings = [];
            //       attributes.distances = [];

            //       for (var k = 1; k < path.length; k++) {
            //         //one coordinate = one point
            //         var coordinate = path[k];
            //         var previousCoordinate = path[k - 1];
            //         var from = turf.point([previousCoordinate.lon, previousCoordinate.lat]);
            //         var to = turf.point([coordinate.lon, coordinate.lat]);
            //         var distance = turf.distance(from, to);
            //         var bearing = turf.bearing(from, to);
            //         attributes.distances.push(distance)
            //         attributes.bearings.push(bearing)
            //       };
            //       vectorComponent.push(attributes)
            //     };
            //   };
            //   var output = {
            //     tags: json.tags,
            //     components: vectorComponents
            //   };
            //   return output
            // }

            function convertStreetToCoordinates(json){
                  var components = json.components;
                  var nodeLUT = json.nodes;
                  var componentsWithCoordinates = [];
                  for (var componentCounter = 0; componentCounter < components.length; componentCounter++) {
                        var component = components[ componentCounter ];
                        componentsWithCoordinates[componentCounter] = [];
                        for (var i = 0; i < component.length; i++) {
                              var path = component[i]
                              componentsWithCoordinates[componentCounter][i] = [];
                              for (var j = 0; j < path.length; j++) {
                                    var componentNode = path[j];
                                    componentsWithCoordinates[componentCounter][i][j] = nodeLUT[componentNode];
                              };
                        };
                  };
                  var output = {
                    tags: json.tags,
                    components: componentsWithCoordinates
                  }
                  return output;
            }
        </script>
  </body>
</html>