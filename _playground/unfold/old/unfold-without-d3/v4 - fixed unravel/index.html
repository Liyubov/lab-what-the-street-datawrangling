<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Unravel</title>
  </head>
  <body>
    <canvas id="myCanvas" width="1500" height="1500"></canvas>
  <input id="sliderSmooth" type="range" value="1" min="1" max="10" step="0.01"/>
  <style type="text/css">
    body{
      margin: 0;
      padding: 0;
      background: white;
    }

    canvas{
      /*background: white;*/
      position: absolute;
      top: 0;
      left: 0;
    }

    #sliderSmooth{
      position: absolute;
      top: 20px;
      left: 20px;
    }

  </style>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/3.0.14/turf.js"></script>

  <script>
    //Setup some helper functions
    // Converts from degrees to radians.
    Math.radians = function(degrees) {
      return degrees * Math.PI / 180;
    };
     
    // Converts from radians to degrees.
    Math.degrees = function(radians) {
      return radians * 180 / Math.PI;
    };

    var smoothness = 1;

    init();

    function init(){
      var canvas = document.getElementById("myCanvas"); //reference canvas
      var canvasContext = canvas.getContext("2d"); //set context

      //"import" geojson
      //pro-tip: collapse coordinates ...
      // var streetGeojson = {
      //   "type": "FeatureCollection",
      //   "features": [
      //     {
      //       "type": "Feature",
      //       "properties": {},
      //       "geometry": {
      //         "type": "LineString",
      //         "coordinates": [
      //           [
      //             13.3771606,
      //             52.5281331
      //           ],
      //           [
      //             13.377214333333333,
      //             52.528144766666664
      //           ],
      //           [
      //             13.377268066666668,
      //             52.528156433333336
      //           ],
      //           [
      //             13.3773218,
      //             52.5281681
      //           ],
      //           [
      //             13.377368252941178,
      //             52.52817122941177
      //           ],
      //           [
      //             13.377414705882353,
      //             52.528174358823534
      //           ],
      //           [
      //             13.37746115882353,
      //             52.52817748823529
      //           ],
      //           [
      //             13.377507611764706,
      //             52.52818061764706
      //           ],
      //           [
      //             13.377554064705883,
      //             52.528183747058826
      //           ],
      //           [
      //             13.377600517647059,
      //             52.52818687647059
      //           ],
      //           [
      //             13.377646970588236,
      //             52.52819000588235
      //           ],
      //           [
      //             13.377693423529411,
      //             52.52819313529412
      //           ],
      //           [
      //             13.377739876470589,
      //             52.52819626470588
      //           ],
      //           [
      //             13.377786329411764,
      //             52.52819939411765
      //           ],
      //           [
      //             13.377832782352941,
      //             52.52820252352941
      //           ],
      //           [
      //             13.377879235294117,
      //             52.528205652941175
      //           ],
      //           [
      //             13.377925688235294,
      //             52.52820878235294
      //           ],
      //           [
      //             13.37797214117647,
      //             52.52821191176471
      //           ],
      //           [
      //             13.378018594117647,
      //             52.528215041176466
      //           ],
      //           [
      //             13.378065047058822,
      //             52.52821817058823
      //           ],
      //           [
      //             13.3781115,
      //             52.5282213
      //           ],
      //           [
      //             13.378158366666666,
      //             52.528224475
      //           ],
      //           [
      //             13.378205233333333,
      //             52.52822765
      //           ],
      //           [
      //             13.3782521,
      //             52.528230825
      //           ],
      //           [
      //             13.378298966666666,
      //             52.528234
      //           ],
      //           [
      //             13.378345833333332,
      //             52.528237175
      //           ],
      //           [
      //             13.3783927,
      //             52.528240350000004
      //           ],
      //           [
      //             13.378439566666668,
      //             52.528243525
      //           ],
      //           [
      //             13.378486433333334,
      //             52.528246700000004
      //           ],
      //           [
      //             13.3785333,
      //             52.528249875
      //           ],
      //           [
      //             13.378580166666667,
      //             52.528253050000004
      //           ],
      //           [
      //             13.378627033333334,
      //             52.528256225
      //           ],
      //           [
      //             13.3786739,
      //             52.5282594
      //           ],
      //           [
      //             13.378723733333334,
      //             52.52826216666667
      //           ],
      //           [
      //             13.378773566666666,
      //             52.52826493333333
      //           ],
      //           [
      //             13.3788234,
      //             52.5282677
      //           ],
      //           [
      //             13.378871122222222,
      //             52.528270733333336
      //           ],
      //           [
      //             13.378918844444444,
      //             52.528273766666665
      //           ],
      //           [
      //             13.378966566666666,
      //             52.5282768
      //           ],
      //           [
      //             13.379014288888888,
      //             52.528279833333336
      //           ],
      //           [
      //             13.379062011111111,
      //             52.528282866666665
      //           ],
      //           [
      //             13.379109733333333,
      //             52.5282859
      //           ],
      //           [
      //             13.379157455555555,
      //             52.528288933333336
      //           ],
      //           [
      //             13.379205177777777,
      //             52.528291966666664
      //           ],
      //           [
      //             13.3792529,
      //             52.528295
      //           ],
      //           [
      //             13.379298428571428,
      //             52.528297114285714
      //           ],
      //           [
      //             13.379343957142856,
      //             52.52829922857143
      //           ],
      //           [
      //             13.379389485714285,
      //             52.52830134285714
      //           ],
      //           [
      //             13.379435014285715,
      //             52.52830345714286
      //           ],
      //           [
      //             13.379480542857143,
      //             52.528305571428575
      //           ],
      //           [
      //             13.379526071428572,
      //             52.52830768571429
      //           ],
      //           [
      //             13.3795716,
      //             52.5283098
      //           ],
      //           [
      //             13.379618627777777,
      //             52.52831198333334
      //           ],
      //           [
      //             13.379665655555556,
      //             52.52831416666667
      //           ],
      //           [
      //             13.379712683333334,
      //             52.528316350000004
      //           ],
      //           [
      //             13.379759711111111,
      //             52.528318533333334
      //           ],
      //           [
      //             13.379806738888888,
      //             52.52832071666667
      //           ],
      //           [
      //             13.379853766666667,
      //             52.5283229
      //           ],
      //           [
      //             13.379900794444444,
      //             52.528325083333335
      //           ],
      //           [
      //             13.379947822222222,
      //             52.528327266666665
      //           ],
      //           [
      //             13.37999485,
      //             52.52832945
      //           ],
      //           [
      //             13.380041877777778,
      //             52.52833163333334
      //           ],
      //           [
      //             13.380088905555557,
      //             52.52833381666667
      //           ],
      //           [
      //             13.380135933333333,
      //             52.528336
      //           ],
      //           [
      //             13.38018296111111,
      //             52.52833818333333
      //           ],
      //           [
      //             13.380229988888889,
      //             52.52834036666667
      //           ],
      //           [
      //             13.380277016666666,
      //             52.52834255
      //           ],
      //           [
      //             13.380324044444444,
      //             52.528344733333334
      //           ],
      //           [
      //             13.380371072222221,
      //             52.52834691666666
      //           ],
      //           [
      //             13.3804181,
      //             52.5283491
      //           ],
      //           [
      //             13.380463316666667,
      //             52.528352
      //           ],
      //           [
      //             13.380508533333334,
      //             52.5283549
      //           ],
      //           [
      //             13.38055375,
      //             52.528357799999995
      //           ],
      //           [
      //             13.380598966666666,
      //             52.5283607
      //           ],
      //           [
      //             13.380644183333333,
      //             52.5283636
      //           ],
      //           [
      //             13.3806894,
      //             52.5283665
      //           ],
      //           [
      //             13.380731879999999,
      //             52.528337439999994
      //           ],
      //           [
      //             13.38077436,
      //             52.52830838
      //           ],
      //           [
      //             13.38081684,
      //             52.528279319999996
      //           ],
      //           [
      //             13.38085932,
      //             52.52825026
      //           ],
      //           [
      //             13.3809018,
      //             52.5282212
      //           ],
      //           [
      //             13.3809018,
      //             52.5282212
      //           ],
      //           [
      //             13.3809085,
      //             52.5282176
      //           ],
      //           [
      //             13.3809794,
      //             52.5281798
      //           ],
      //           [
      //             13.381023299999999,
      //             52.528168199999996
      //           ],
      //           [
      //             13.3810672,
      //             52.5281566
      //           ],
      //           [
      //             13.381116,
      //             52.5281449
      //           ],
      //           [
      //             13.3811648,
      //             52.5281332
      //           ],
      //           [
      //             13.3812136,
      //             52.528121500000005
      //           ],
      //           [
      //             13.3812624,
      //             52.5281098
      //           ],
      //           [
      //             13.3813112,
      //             52.5280981
      //           ],
      //           [
      //             13.3813672,
      //             52.52807785
      //           ],
      //           [
      //             13.3814232,
      //             52.5280576
      //           ],
      //           [
      //             13.3814232,
      //             52.5280576
      //           ],
      //           [
      //             13.381491066666667,
      //             52.52800513333333
      //           ],
      //           [
      //             13.381533833333334,
      //             52.52797206666667
      //           ],
      //           [
      //             13.3815766,
      //             52.527939
      //           ],
      //           [
      //             13.381616050000002,
      //             52.5279085
      //           ],
      //           [
      //             13.3816555,
      //             52.527878
      //           ],
      //           [
      //             13.381691985714287,
      //             52.527850314285715
      //           ],
      //           [
      //             13.381728471428572,
      //             52.52782262857143
      //           ],
      //           [
      //             13.381764957142858,
      //             52.52779494285714
      //           ],
      //           [
      //             13.381801442857142,
      //             52.52776725714286
      //           ],
      //           [
      //             13.381837928571429,
      //             52.527739571428576
      //           ],
      //           [
      //             13.381874414285713,
      //             52.52771188571429
      //           ],
      //           [
      //             13.3819109,
      //             52.5276842
      //           ],
      //           [
      //             13.381948666666666,
      //             52.52765806666667
      //           ],
      //           [
      //             13.381986433333333,
      //             52.52763193333333
      //           ],
      //           [
      //             13.3820242,
      //             52.5276058
      //           ],
      //           [
      //             13.382061966666667,
      //             52.52757966666667
      //           ],
      //           [
      //             13.382099733333334,
      //             52.52755353333333
      //           ],
      //           [
      //             13.3821375,
      //             52.5275274
      //           ],
      //           [
      //             13.382186500000001,
      //             52.5275057
      //           ],
      //           [
      //             13.3822355,
      //             52.527484
      //           ],
      //           [
      //             13.3822845,
      //             52.5274623
      //           ],
      //           [
      //             13.38233445,
      //             52.52744765
      //           ],
      //           [
      //             13.3823844,
      //             52.527433
      //           ],
      //           [
      //             13.382432,
      //             52.527420766666665
      //           ],
      //           [
      //             13.3824796,
      //             52.527408533333336
      //           ],
      //           [
      //             13.3825272,
      //             52.5273963
      //           ],
      //           [
      //             13.382571672727273,
      //             52.52738562727273
      //           ],
      //           [
      //             13.382616145454545,
      //             52.52737495454545
      //           ],
      //           [
      //             13.382660618181818,
      //             52.52736428181818
      //           ],
      //           [
      //             13.382705090909091,
      //             52.52735360909091
      //           ],
      //           [
      //             13.382749563636365,
      //             52.52734293636364
      //           ],
      //           [
      //             13.382794036363636,
      //             52.52733226363636
      //           ],
      //           [
      //             13.38283850909091,
      //             52.52732159090909
      //           ],
      //           [
      //             13.382882981818183,
      //             52.52731091818182
      //           ],
      //           [
      //             13.382927454545456,
      //             52.52730024545455
      //           ],
      //           [
      //             13.382971927272727,
      //             52.52728957272727
      //           ],
      //           [
      //             13.3830164,
      //             52.5272789
      //           ],
      //           [
      //             13.383061895238097,
      //             52.52726821428571
      //           ],
      //           [
      //             13.38310739047619,
      //             52.527257528571425
      //           ],
      //           [
      //             13.383152885714287,
      //             52.52724684285714
      //           ],
      //           [
      //             13.383198380952381,
      //             52.52723615714286
      //           ],
      //           [
      //             13.383243876190477,
      //             52.52722547142857
      //           ],
      //           [
      //             13.383289371428571,
      //             52.527214785714285
      //           ],
      //           [
      //             13.383334866666667,
      //             52.5272041
      //           ],
      //           [
      //             13.383380361904763,
      //             52.52719341428571
      //           ],
      //           [
      //             13.383425857142857,
      //             52.527182728571425
      //           ],
      //           [
      //             13.383471352380953,
      //             52.52717204285714
      //           ],
      //           [
      //             13.383516847619047,
      //             52.52716135714286
      //           ],
      //           [
      //             13.383562342857143,
      //             52.52715067142857
      //           ],
      //           [
      //             13.383607838095237,
      //             52.527139985714285
      //           ],
      //           [
      //             13.383653333333333,
      //             52.5271293
      //           ],
      //           [
      //             13.38369882857143,
      //             52.52711861428571
      //           ],
      //           [
      //             13.383744323809523,
      //             52.527107928571425
      //           ],
      //           [
      //             13.38378981904762,
      //             52.52709724285714
      //           ],
      //           [
      //             13.383835314285713,
      //             52.52708655714286
      //           ],
      //           [
      //             13.38388080952381,
      //             52.52707587142857
      //           ],
      //           [
      //             13.383926304761903,
      //             52.527065185714285
      //           ],
      //           [
      //             13.3839718,
      //             52.5270545
      //           ],
      //           [
      //             13.384021,
      //             52.52704285
      //           ],
      //           [
      //             13.3840702,
      //             52.527031199999996
      //           ],
      //           [
      //             13.384119400000001,
      //             52.52701955
      //           ],
      //           [
      //             13.3841686,
      //             52.5270079
      //           ],
      //           [
      //             13.384217875000001,
      //             52.52699625
      //           ],
      //           [
      //             13.38426715,
      //             52.526984600000006
      //           ],
      //           [
      //             13.384316425,
      //             52.52697295
      //           ],
      //           [
      //             13.3843657,
      //             52.5269613
      //           ],
      //           [
      //             13.384412866666667,
      //             52.52695013333334
      //           ],
      //           [
      //             13.384460033333333,
      //             52.52693896666667
      //           ],
      //           [
      //             13.3845072,
      //             52.5269278
      //           ],
      //           [
      //             13.384564433333333,
      //             52.526917366666666
      //           ],
      //           [
      //             13.384621666666668,
      //             52.526906933333336
      //           ],
      //           [
      //             13.3846789,
      //             52.5268965
      //           ],
      //           [
      //             13.3847433,
      //             52.5268913
      //           ],
      //           [
      //             13.3848077,
      //             52.5268861
      //           ],
      //           [
      //             13.3848649,
      //             52.52688956666667
      //           ],
      //           [
      //             13.384922099999999,
      //             52.52689303333333
      //           ],
      //           [
      //             13.3849793,
      //             52.5268965
      //           ],
      //           [
      //             13.385026822222223,
      //             52.52690168888889
      //           ],
      //           [
      //             13.385074344444444,
      //             52.526906877777776
      //           ],
      //           [
      //             13.385121866666667,
      //             52.52691206666667
      //           ],
      //           [
      //             13.385169388888889,
      //             52.52691725555555
      //           ],
      //           [
      //             13.385216911111112,
      //             52.526922444444445
      //           ],
      //           [
      //             13.385264433333333,
      //             52.52692763333333
      //           ],
      //           [
      //             13.385311955555556,
      //             52.52693282222222
      //           ],
      //           [
      //             13.385359477777778,
      //             52.526938011111106
      //           ],
      //           [
      //             13.385407,
      //             52.5269432
      //           ],
      //           [
      //             13.385453342857144,
      //             52.526949347619045
      //           ],
      //           [
      //             13.385499685714286,
      //             52.52695549523809
      //           ],
      //           [
      //             13.38554602857143,
      //             52.52696164285714
      //           ],
      //           [
      //             13.385592371428572,
      //             52.52696779047619
      //           ],
      //           [
      //             13.385638714285715,
      //             52.52697393809524
      //           ],
      //           [
      //             13.385685057142858,
      //             52.526980085714285
      //           ],
      //           [
      //             13.385731400000001,
      //             52.52698623333333
      //           ],
      //           [
      //             13.385777742857144,
      //             52.52699238095238
      //           ],
      //           [
      //             13.385824085714287,
      //             52.526998528571426
      //           ],
      //           [
      //             13.38587042857143,
      //             52.52700467619047
      //           ],
      //           [
      //             13.38591677142857,
      //             52.527010823809526
      //           ],
      //           [
      //             13.385963114285714,
      //             52.52701697142857
      //           ],
      //           [
      //             13.386009457142857,
      //             52.52702311904762
      //           ],
      //           [
      //             13.3860558,
      //             52.527029266666666
      //           ],
      //           [
      //             13.386102142857142,
      //             52.52703541428571
      //           ],
      //           [
      //             13.386148485714285,
      //             52.52704156190476
      //           ],
      //           [
      //             13.386194828571428,
      //             52.527047709523806
      //           ],
      //           [
      //             13.386241171428571,
      //             52.52705385714286
      //           ],
      //           [
      //             13.386287514285714,
      //             52.52706000476191
      //           ],
      //           [
      //             13.386333857142857,
      //             52.527066152380954
      //           ],
      //           [
      //             13.3863802,
      //             52.5270723
      //           ],
      //           [
      //             13.386431949999999,
      //             52.5270776
      //           ],
      //           [
      //             13.3864837,
      //             52.5270829
      //           ],
      //           [
      //             13.3868528,
      //             52.5271194
      //           ]
      //         ]
      //       }
      //     }
      //   ]
      // }

      var streetGeojson = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {},
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [
            13.424434661865234,
            52.538987736760156
          ],
          [
            13.42872619628906,
            52.53749989570035
          ],
          [
            13.427567481994629,
            52.53642966305865
          ],
          [
            13.423705101013184,
            52.53778702684868
          ],
          [
            13.423190116882324,
            52.53726496881862
          ],
          [
            13.431086540222168,
            52.53436743391975
          ],
          [
            13.433318138122559,
            52.53347986245227
          ],
          [
            13.432374000549316,
            52.53287943628648
          ],
          [
            13.434305191040039,
            52.53186130358989
          ],
          [
            13.43327522277832,
            52.531339175101614
          ],
          [
            13.431472778320312,
            52.53201794092583
          ],
          [
            13.430142402648926,
            52.5311564286641
          ],
          [
            13.428382873535156,
            52.53199183474197
          ],
          [
            13.429412841796875,
            52.532931647583325
          ],
          [
            13.425850868225098,
            52.534419643447364
          ],
          [
            13.433103561401367,
            52.5362469378053
          ],
          [
            13.434519767761229,
            52.537421586879454
          ],
          [
            13.433361053466797,
            52.53799584832261
          ],
          [
            13.43228816986084,
            52.537734821325024
          ],
          [
            13.429198265075684,
            52.53875281783963
          ],
          [
            13.425507545471191,
            52.537839232310276
          ],
          [
            13.423833847045897,
            52.535750965427226
          ],
          [
            13.425335884094238,
            52.53543771682821
          ],
          [
            13.424606323242188,
            52.534889526402466
          ],
          [
            13.4232759475708,
            52.53517667462188
          ],
          [
            13.42228889465332,
            52.53541161267741
          ],
          [
            13.421473503112793,
            52.53436743391975
          ],
          [
            13.424606323242188,
            52.533349335723294
          ],
          [
            13.42529296875,
            52.5341847000842
          ],
          [
            13.427395820617676,
            52.53285333061479
          ],
          [
            13.42928409576416,
            52.53394975546398
          ],
          [
            13.430743217468262,
            52.53277501350654
          ],
          [
            13.430228233337402,
            52.52956389180582
          ],
          [
            13.426580429077148,
            52.53039932817868
          ],
          [
            13.426580429077148,
            52.52956389180582
          ]
        ]
      }
    }
  ]
}
      var coordinates = streetGeojson.features[0].geometry.coordinates;
      legs = getLegsFromCoordinates( coordinates );
      addAdditionalInfoToLegs(legs);
      addBendInformationToLegs(legs, 200, 20);

      var startX = 100;
      var startY = 200;
      var currentX = startX;
      var currentY = startY;
      //legs = instantUnfold(legs) //only for testing
      //showAngleDifference(legs);
      

      $(document).on('input', '#sliderSmooth', function() {
        var smoothness = $(this).val(); 
        //resetCurrentAngle(legs);
        instantUnfold(legs, smoothness)
        var percentage = smoothness;
        normalize(legs, percentage);
        drawStreet(legs, canvas, canvasContext, currentX, currentY, startX, startY);     
      });

      drawStreet(legs, canvas, canvasContext, currentX, currentY, startX, startY);
    }

    function resetCurrentAngle(legs){
      for (var i = 0; i < legs.length; i++) {
        legs[i].currentAngleDifference = legs[i].startAngleDifference;
      };
    }



    function normalize(legs, percentage){
      console.log(legs);
      var dx = 0;
      var dy = 0;
      var currentAngle = 0;
      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i];
        currentAngle += leg.currentAngleDifference;
        var dxc = Math.sin( Math.radians( currentAngle) ) * convertDistanceToPixels( leg.length );
        var dyc = -Math.cos( Math.radians( currentAngle) ) * convertDistanceToPixels( leg.length );
        dx += dxc;
        dy += dyc;
      };
      //var theta = Math.atan(dy/dx)
      var theta = Math.atan(dy/dx);
      theta = theta * (180/Math.PI) // rads to degs
      console.log('dx', dx, 'dy', dy, 'angle', theta);
      //legs[0].currentAngleDifference = (90 - theta) * percentage + legs[0].currentAngleDifference * (1-percentage) +  25;
      legs[0].currentAngleDifference = 90 - theta;
    }

    function addAdditionalInfoToLegs(legs) {
      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i];
        if (i > 0) {
          var previousLeg = legs[i-1];  
          legs[i].startAngleDifference = leg.angle - previousLeg.angle;
          while (legs[i].startAngleDifference < -180) {
            legs[i].startAngleDifference += 360;
          };
          while (legs[i].startAngleDifference > 180) {
            legs[i].startAngleDifference -= 360;
          };
          legs[i].headDistance = leg.length + previousLeg.headDistance;
        }else{
          //console.log("first leg, using initial values");
          legs[i].startAngleDifference = leg.angle;
          legs[i].headDistance = leg.length;
        }
        legs[i].currentAngleDifference = legs[i].startAngleDifference;
      };
    }

    function addBendInformationToLegs(legs, slopeWidth, slopeHeight){
      var comparison = slopeWidth + slopeHeight;
      var turnCounter = 0;
      var previousDirection = "";
      var currentDirection = "";

      for (var i = 0; i < legs.length; i++) {
        if (i == 0) {
          //Edge case for the first leg
          legs[i].angleDifferenceTarget = 90;
          currentDirection = "side";
          previousDirection = currentDirection;
          turnCounter += 1;
        }else{
          var leg = legs[i];
          var headDistanceInMeters = leg.headDistance*1000;
          if (headDistanceInMeters % comparison < slopeWidth) {
            currentDirection = "side";
          }else{
            currentDirection = "down";
          }
          if (currentDirection != previousDirection) {
            turnCounter += 1;
            if (turnCounter % 4 < 2) {
              //Left Turn
              legs[i].angleDifferenceTarget = -90;
            }else{
              //Right Turn
              legs[i].angleDifferenceTarget = 90;
            }
          }else{
            //No Turn
            legs[i].angleDifferenceTarget = 0;
          }
          previousDirection = currentDirection;
        }
      };
    }

    function getLegsFromCoordinates(coordinates){
      var legs = [];
      for (var i = 1; i < coordinates.length; i++) {
        var coordinateFrom = coordinates[i - 1];
        var coordinateTo   = coordinates[i];
        var pointFrom = turf.point( coordinateFrom );
        var pointTo   = turf.point( coordinateTo );
        var bearing   = turf.bearing(pointFrom, pointTo);
        var angleDistance = bearing;
        if (i > 1) {
          angleDistance = legs[i-2].angleDistance - bearing;
        };
        var distance  = turf.distance(pointFrom, pointTo, "kilometers");
        var headDistance = distance;
        if (i > 1) {
          headDistance = distance + legs[i-2].headDistance;
        };

        var leg = {
          "this": i,
          "taken": i-1,
          "from":{
            "lat": coordinateFrom[1],
            "lon": coordinateFrom[0]
          },
          "to":{
            "lat": coordinateTo[1],
            "lon": coordinateTo[0]
          },
          "angle": bearing,
          "length": distance
        }
        legs.push(leg);
      };
      return legs;
    }


    function convertDistanceToPixels(kilometers){
      //return kilometers * 1370; //equals zoom level 16
      return kilometers * 200;
    }

    function drawStreet(legs, canvas, canvasContext, currentX, currentY, startX, startY){
      canvasContext.clearRect(0, 0, canvas.width, canvas.height);
      canvasContext.beginPath(); 
      canvasContext.moveTo(currentX,currentY);

      var startAngle = 0;
      var currentAngle = startAngle;

      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i];
        currentAngle += leg.currentAngleDifference;
        var dx = Math.sin( Math.radians( currentAngle) ) * convertDistanceToPixels( leg.length );
        var dy = -Math.cos( Math.radians( currentAngle) ) * convertDistanceToPixels( leg.length );
        currentX += dx;
        currentY += dy;
        canvasContext.lineTo(currentX, currentY);
      };

      currentX = startX;
      currentY = startY;

      canvasContext.stroke();
      canvasContext.closePath();
    }

    //http://stackoverflow.com/questions/1878907/the-smallest-difference-between-2-angles
    function distanceBetweenAngles(startingAngle, targetAngle){
        startingAngle = Math.radians(startingAngle);
        targetAngle = Math.radians(targetAngle);
        var angle = Math.atan2(Math.sin(targetAngle - startingAngle), Math.cos(targetAngle - startingAngle));
        return Math.degrees(angle);
    };

    function showAngleDifference(legs){
      var d = 0;
      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i]
        if (i > 0) {
          d += leg.startAngleDifference;
          console.log('leg ' + i + ': ' + leg.startAngleDifference);
        }
      };
      console.log('offset = ' + d);
      var numberOfLegs = legs.length - 1;
      var individualD = (-d/numberOfLegs);
      console.log('distribute to ' + numberOfLegs );
      console.log('add to every leg ' + individualD);

      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i]
        if (i > 0) {
          leg.currentAngleDifference = leg.startAngleDifference + individualD; 
        }
      };
    }

    //function y = (cos(x*pi/180) + 1)/2
    //is 1 at 0
    //zero at 180 and -180
    //smooth in between
    //-> might be used to only smooth out small values, but keep the harsh edges ... maybe

    function easeTest(x, scope){
      if (x > scope) {
        return 0
      }else if(scope < -scope){
        return 0
      }else{
        return (Math.cos(x * Math.PI / scope) + 1)/2;
      }
    }

    function smoothOnlySmallValues(legs, scope){
      for (var i = 0; i < legs.length; i++) {
        var leg = legs[i];
        var d = leg.startAngleDifference;
        var p = 1 - easeTest(d, scope);
        var newD = d*p;
        console.log(d + " -> " + newD);
        leg.currentAngleDifference = newD;
      }
    }

    function instantUnfold(legs, smoothness){
      //console.log("unfold");
      for (var i = 0; i < legs.length; i++) {
        console.log( i, legs[i].startAngleDifference );
        //console.log(legs[i].startAngleDifference + " = " + legs[i].angleDifferenceTarget)
        //legs[i].startAngleDifference = legs[i].angleDifferenceTarget;
        //legs[i].startAngleDifference = legs[i].startAngleDifference / 3
        if (i==0) {
          legs[i].currentAngleDifference = 90
        }else{
          legs[i].currentAngleDifference = legs[i].startAngleDifference / smoothness;  
        }
        
      };
    }
  </script>
  </body>
</html>