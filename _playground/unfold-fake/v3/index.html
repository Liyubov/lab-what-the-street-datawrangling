<title>Snake</title>
<div id="svgWrapper"></div>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script>
    var snake = {
		curveRadius: 5,
		width: 600,
		meterPerPixel: 1.2
	}

    var urlToJson = "./data/bendness_allStreetsBerlin.json"
    $.getJSON( urlToJson, function(bendness) {
    	drawSnake(bendness);
	});

    function drawSnake(bendness){
		updateSnakeProperties();

		var margin = {
			top: 150,
			left: 150
		}

		var distanceCounter = 0;
		var mPerPixel = 2;
		var gap = 2 * mPerPixel;
		var arrayOfSvgPieces = [];
		var svgHeight;
		var svgWidth = snake.width + snake.curveRadius*2 + margin.left + 10;

		console.log('streets: ', bendness.length);
		for (var i = 0; i < bendness.length; i++) {
			var street = bendness[i];
			arrayOfSvgPieces.push('<path stroke="#4990E2" stroke-width="1" fill="none" d="');
			for (var j = 0; j < street.length; j++) {
				var point = street[j]
				distanceCounter += point.distance * mPerPixel;

				var cursor = getPositionOnSnake( distanceCounter );
				var bumpHeight = - point.y * 20;
				var dx = Math.sin(cursor.angle) * bumpHeight;
				var dy = Math.cos(cursor.angle) * bumpHeight;
				
				var x = cursor.x + margin.left - dx;
				var y = cursor.y + margin.top - dy;
				svgHeight = y;
				if (j==0) {
					arrayOfSvgPieces.push('M' + x + ',' + y);
				}else{
					arrayOfSvgPieces.push('L' + x + ',' + y + ' ');
				}
			};
			arrayOfSvgPieces.push('"/>');
			console.log(Math.round(distanceCounter/10)/100 + 'km');
		    distanceCounter += gap;
		};

		svgHeight += margin.top;
		svgHeight += 10;

		arrayOfSvgPieces.push('" />');
		arrayOfSvgPieces.push('</svg>');

		arrayOfSvgPieces.unshift('<svg width="' + svgWidth + 'px" height="' + svgHeight +'px"  viewBox="0 0 ' + svgWidth + ' ' + svgHeight + '">');

		var svgCode = arrayOfSvgPieces.join("");
		$("#svgWrapper").html( svgCode );
    }

	function updateSnakeProperties(){
		var curveCircumference = (2 * snake.curveRadius * Math.PI);
		var curveLength = curveCircumference/2;
		snake.curveCircumference = curveCircumference;
		snake.curveLength = curveLength;
	}

	function getPositionOnSnake(position){
		var snakeSegmentLength = 2 * snake.width + 2 * snake.curveLength; //width, curve down, width, curve down
		var segmentNumber = Math.floor(position / snakeSegmentLength);
		var modulo = position % snakeSegmentLength;
		var part;
		var partPosition;
		var pivot;
		if (modulo < snake.width * 1 + snake.curveLength * 0) {
			part = 0;
			partPosition = modulo;
			pivot = 0;
		}else if(modulo < snake.width * 1 + snake.curveLength * 1){
			part = 1;
			partPosition = modulo - snake.width;
			pivot = 1;
		}else if(modulo < snake.width * 2 + snake.curveLength * 1){
			part = 2;
			partPosition = modulo - snake.width - snake.curveLength;
			pivot = 1;
		}else if(modulo < snake.width * 2 + snake.curveLength * 2){
			part = 3;
			partPosition = modulo - snake.width * 2 - snake.curveLength;
			pivot = 2;
		}else{
			console.log('this should not happen');
		}

		var x;
		var y;
		var angle;
		var angleOutput;

		switch(part){
			case 0:
				x = partPosition + snake.curveRadius;
				y = pivot * snake.curveRadius * 2;
				angleOutput = toRadians(0);
				break;

			case 1:
				x = partPosition + snake.curveRadius;
				y = pivot * snake.curveRadius * 2;
				var completionPercentage = partPosition / snake.curveLength;
				angle = toRadians(180 - completionPercentage * 180);
				var dx = Math.sin(angle) * snake.curveRadius;
				var dy = Math.cos(angle) * snake.curveRadius;
				x = dx + snake.width + snake.curveRadius;
				y = pivot * snake.curveRadius + dy;
				angleOutput = toRadians(completionPercentage * 180);
				break;
			case 2:
				x = (snake.width - partPosition) + snake.curveRadius;
				y = pivot * snake.curveRadius * 2;
				angleOutput = toRadians(180);
				break;

			case 3:
				var completionPercentage = partPosition / snake.curveLength;
				angle = - toRadians(180 - completionPercentage * 180);
				var dx = Math.sin(angle) * snake.curveRadius;
				var dy = Math.cos(angle) * snake.curveRadius;
				x = dx + snake.curveRadius;
				y = pivot * snake.curveRadius + dy + snake.curveRadius;
				angleOutput = toRadians(completionPercentage * 180 - 180);
				break;
		}

		var segmentTop = segmentNumber * snake.curveRadius * 4;
		var output = {
			x: x,
			y: y + segmentTop,
			angle: angleOutput
		}

		return output;
	}

	function toRadians(degrees) {
      return degrees * Math.PI / 180;
    };
</script>