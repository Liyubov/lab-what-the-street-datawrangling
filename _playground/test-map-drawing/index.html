<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Map Zoom Callback</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.28.0/mapbox-gl.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Turf.js/3.0.14/turf.min.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.28.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>

</head>
<body>

<div id='map'></div>

<script>
    var mode = 1;
    var stuttgart = {
        lat: 48.776519,
        lng: 9.178115
    }

    var bounds = [
        [ 9.096398, 48.737059],
        [ 9.254743, 48.834708]
    ]

    mapboxgl.accessToken = 'pk.eyJ1IjoiYm9nbmVyc3RlcGhhbiIsImEiOiJBMnlqbnZrIn0.YwiGRgpheNMPujZn-JBh6Q';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
        center: stuttgart, // starting position
        zoom: 12 // starting zoom
    });

    map.on('load', function () {
        addSource("street");
        setInterval(function(){
            switchView();
        }, 1000);

        setInterval(function(){
            drawFakeData();
        }, 50);
    });

    function drawFakeData(){
        var origin = {
          "type": "Feature",
          "geometry": {
            "type": "Point",
            "coordinates": [9.178115, 48.776519]
          }
        };

        var lengths = [100,20,30,40,50,100,200, 450, 311, 20, 70, 90, 400, 100,20,30,40,50,100,200, 450, 311, 20, 70, 90, 400, 100,20,30,40,50,100,200, 450, 311, 20, 70, 90, 400];
        var angularRange = 130;

        var cursor = JSON.parse( JSON.stringify(origin) );
        
        var coordinates = [];
        coordinates.push(cursor.geometry.coordinates);
        for (var i = 0; i < lengths.length; i++) {
            var bearing = Math.random() * angularRange - angularRange/2;
            var lengthInKm = lengths[i] / 1000;

            cursor = turf.destination(cursor, lengthInKm/2, bearing);
            coordinates.push(cursor.geometry.coordinates);
        };

        var linestring = turf.lineString(coordinates);
        map.getSource('street').setData(linestring);

        //console.log('linestring', JSON.stringify(linestring));
    }


    function addSource(name){
        map.addSource(name, {
            "type": "geojson",
            "data": {
                "type": "Feature",
                "properties": {},
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                        [-122.48369693756104, 37.83381888486939],
                        [-122.48348236083984, 37.83317489144141]
                    ]
                }
            }
        });
        map.addLayer({
            "id": name,
            "type": "line",
            "source": name,
            "layout": {
                "line-join": "round",
                "line-cap": "round"
            },
            "paint": {
                "line-color": "#888",
                "line-width": 8
            }
        });
    }

    function switchView(){
        if (mode == 1) {
            map.flyTo({
                center: stuttgart,
                zoom: 12,
                speed: 1
            });
        }else{
            map.fitBounds(bounds, {padding: 100});
        }
        mode = -mode;
    }
</script>

</body>
</html>
